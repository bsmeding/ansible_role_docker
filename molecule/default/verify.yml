---
- name: Verify Docker Role
  hosts: all
  tasks:
    - name: Find Docker binary location
      ansible.builtin.command: which docker || command -v docker
      register: docker_binary_path
      changed_when: false
      failed_when: false

    - name: Check if Docker packages are installed
      ansible.builtin.shell: |
        if command -v dpkg >/dev/null 2>&1; then
          dpkg -l | grep -E '^ii.*docker-ce|^ii.*docker.io' || true
        elif command -v rpm >/dev/null 2>&1; then
          rpm -qa | grep docker || true
        fi
      register: docker_package_check
      changed_when: false
      failed_when: false
      when: docker_binary_path.rc != 0

    - name: Fail if Docker is not installed
      ansible.builtin.fail:
        msg: |
          Docker binary not found and Docker packages not detected.
          This indicates the converge phase may have failed to install Docker.
          Please check the converge playbook output for errors.
      when:
        - docker_binary_path.rc != 0
        - docker_package_check.stdout | length == 0

    - name: Verify Docker binary is available
      ansible.builtin.command: "{{ docker_binary_path.stdout }} --version"
      register: docker_version_result
      changed_when: false
      failed_when: docker_version_result.rc != 0
      when: docker_binary_path.rc == 0

    - name: Set Docker version output safely
      ansible.builtin.set_fact:
        docker_version_output: "{{ docker_version_result.stdout | default('N/A') }}"
      when:
        - docker_version_result is defined
        - docker_version_result.stdout is defined

    - name: Show Docker version details
      ansible.builtin.debug:
        msg: "Docker Version Output: {{ docker_version_output | default('Docker binary not found') }}"
      when: docker_version_output is defined

    # - name: Verify Docker service is running
    #   ansible.builtin.command: systemctl is-active docker
    #   register: docker_service_status
    #   when: ansible_service_mgr == 'systemd'
    #   changed_when: false
    #   failed_when: "'active' not in docker_service_status.stdout"

    # - name: Display Docker service status
    #   ansible.builtin.debug:
    #     msg: "Docker service is {{ docker_service_status.stdout.strip() }}"
    #   when: ansible_service_mgr == 'systemd'

    - name: Gather service facts
      ansible.builtin.service_facts:
      register: service_facts_result
      failed_when: false
      changed_when: false

    - name: Check if Docker service exists in facts
      ansible.builtin.set_fact:
        docker_service_exists: "{{ ansible_facts.services is defined and 'docker.service' in ansible_facts.services }}"
      when: ansible_facts.services is defined

    - name: Assert Docker is running
      ansible.builtin.assert:
        that:
          - ansible_facts.services is defined
          - ansible_facts.services['docker.service'] is defined
          - ansible_facts.services['docker.service'].state == 'running'
        fail_msg: "Docker service is not running"
        success_msg: "Docker service is running"
      when:
        - ansible_facts.services is defined
        - ansible_facts.services['docker.service'] is defined

    - name: Restart Docker service to ensure daemon matches installed packages
      ansible.builtin.service:
        name: docker
        state: restarted
      become: true
      when: ansible_service_mgr == 'systemd'

    - name: Set Docker command path
      ansible.builtin.set_fact:
        docker_cmd: "{{ docker_binary_path.stdout }}"
      when: docker_binary_path.rc == 0

    - name: Wait for Docker daemon to be ready after restart
      ansible.builtin.command: "{{ docker_cmd }} info"
      register: docker_info_result
      until: docker_info_result.rc == 0
      retries: 10
      delay: 2
      changed_when: false
      when: docker_cmd is defined

    - name: Set Docker daemon info safely
      ansible.builtin.set_fact:
        docker_daemon_info: "{{ docker_info_result.stdout | default('N/A') }}"
      when:
        - docker_info_result is defined
        - docker_info_result.stdout is defined

    - name: Show Docker daemon information
      ansible.builtin.debug:
        msg: "Docker Daemon Info: {{ docker_daemon_info | default('Docker daemon info not available') }}"
      when: docker_daemon_info is defined

    - name: Pull the 'hello-world' image
      ansible.builtin.command: "{{ docker_cmd }} pull hello-world"
      register: docker_pull_result
      changed_when: true
      failed_when: docker_pull_result.rc != 0
      when: docker_cmd is defined

    - name: Set Docker pull result safely
      ansible.builtin.set_fact:
        docker_pull_output: "{{ docker_pull_result.stdout | default('N/A') }}"
      when:
        - docker_pull_result is defined
        - docker_pull_result.stdout is defined

    - name: Show result of pulling the 'hello-world' image
      ansible.builtin.debug:
        msg: "Pulling 'hello-world' completed with output: {{ docker_pull_output | default('Pull result not available') }}"
      when: docker_pull_output is defined

    # - name: Run a test container (hello-world)
    #   ansible.builtin.command: docker run --rm hello-world
    #   register: docker_run_result
    #   changed_when: true
    #   failed_when: docker_run_result.rc != 0

    # - name: Display test container output
    #   ansible.builtin.debug:
    #     msg: >
    #       Running 'hello-world' container completed with output:
    #       {{ docker_run_result.stdout_lines | join('\n') }}
